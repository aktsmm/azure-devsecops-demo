# ç’°å¢ƒãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Azure ãƒªã‚½ãƒ¼ã‚¹ï¼ˆAKS/ACA/VM/Storage/ACRï¼‰ã®çŠ¶æ…‹ã‚’åé›†ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ

name: "ğŸ“Š Environment Report"
run-name: "ğŸ“Š Environment Report â€“ triggered by ${{ github.actor }}"

on:
    workflow_dispatch:
        inputs:
            resource_group:
                description: "ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å"
                required: false
                default: "RG-bbs-app-demo"
            output_issue:
                description: "Issue ã«æŠ•ç¨¿ã™ã‚‹"
                type: boolean
                default: false
    schedule:
        # æ¯é€±æœˆæ›œ 09:00 JST (00:00 UTC)
        - cron: "0 0 * * 1"
    workflow_run:
        workflows: ["1ï¸âƒ£ Infrastructure Deploy"]
        types:
            - completed

permissions:
    contents: write
    issues: write
    id-token: write

env:
    RESOURCE_GROUP: ${{ github.event.inputs.resource_group || vars.RESOURCE_GROUP || 'RG-bbs-app-demo' }}

jobs:
    generate-report:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Azure Login
              uses: azure/login@v2
              with:
                  client-id: ${{ vars.AZURE_CLIENT_ID }}
                  tenant-id: ${{ vars.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Collect Environment Data
              id: collect
              run: |
                  echo "ğŸ“Š ç’°å¢ƒæƒ…å ±ã‚’åé›†ä¸­..."

                  REPORT_DATE=$(date +%Y-%m-%d)
                  REPORT_TIME=$(date +%Y-%m-%dT%H:%M:%SZ)

                  # AKS çŠ¶æ…‹å–å¾—
                  echo "ğŸ” AKSçŠ¶æ…‹ã‚’å–å¾—..."
                  AKS_INFO=$(az aks list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0]" -o json 2>/dev/null || echo '{}')
                  AKS_NAME=$(echo $AKS_INFO | jq -r '.name // "N/A"')
                  AKS_STATUS=$(echo $AKS_INFO | jq -r '.provisioningState // "N/A"')
                  AKS_VERSION=$(echo $AKS_INFO | jq -r '.kubernetesVersion // "N/A"')
                  AKS_NODE_COUNT=$(echo $AKS_INFO | jq -r '.agentPoolProfiles[0].count // 0')

                  # ACA çŠ¶æ…‹å–å¾—
                  echo "ğŸ” ACAçŠ¶æ…‹ã‚’å–å¾—..."
                  ACA_INFO=$(az containerapp list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0]" -o json 2>/dev/null || echo '{}')
                  ACA_NAME=$(echo $ACA_INFO | jq -r '.name // "N/A"')
                  ACA_STATUS=$(echo $ACA_INFO | jq -r '.properties.provisioningState // "N/A"')

                  # VM çŠ¶æ…‹å–å¾—
                  echo "ğŸ” VMçŠ¶æ…‹ã‚’å–å¾—..."
                  VM_INFO=$(az vm list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0]" -o json 2>/dev/null || echo '{}')
                  VM_NAME=$(echo $VM_INFO | jq -r '.name // "N/A"')
                  VM_SIZE=$(echo $VM_INFO | jq -r '.hardwareProfile.vmSize // "N/A"')

                  # Storage çŠ¶æ…‹å–å¾—
                  echo "ğŸ” StorageçŠ¶æ…‹ã‚’å–å¾—..."
                  STORAGE_INFO=$(az storage account list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0]" -o json 2>/dev/null || echo '{}')
                  STORAGE_NAME=$(echo $STORAGE_INFO | jq -r '.name // "N/A"')
                  STORAGE_STATUS=$(echo $STORAGE_INFO | jq -r '.provisioningState // "N/A"')

                  # ACR çŠ¶æ…‹å–å¾—
                  echo "ğŸ” ACRçŠ¶æ…‹ã‚’å–å¾—..."
                  ACR_INFO=$(az acr list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0]" -o json 2>/dev/null || echo '{}')
                  ACR_NAME=$(echo $ACR_INFO | jq -r '.name // "N/A"')
                  ACR_STATUS=$(echo $ACR_INFO | jq -r '.provisioningState // "N/A"')

                  # ãƒ˜ãƒ«ã‚¹ã‚µãƒãƒªãƒ¼è¨ˆç®—
                  HEALTHY=0
                  UNHEALTHY=0
                  for status in "$AKS_STATUS" "$ACA_STATUS" "$STORAGE_STATUS" "$ACR_STATUS"; do
                    if [[ "$status" == "Succeeded" || "$status" == "Running" ]]; then
                      ((HEALTHY++))
                    elif [[ "$status" != "N/A" ]]; then
                      ((UNHEALTHY++))
                    fi
                  done

                  # ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
                  echo "REPORT_DATE=$REPORT_DATE" >> $GITHUB_OUTPUT
                  echo "REPORT_TIME=$REPORT_TIME" >> $GITHUB_OUTPUT
                  echo "AKS_NAME=$AKS_NAME" >> $GITHUB_OUTPUT
                  echo "AKS_STATUS=$AKS_STATUS" >> $GITHUB_OUTPUT
                  echo "AKS_VERSION=$AKS_VERSION" >> $GITHUB_OUTPUT
                  echo "AKS_NODE_COUNT=$AKS_NODE_COUNT" >> $GITHUB_OUTPUT
                  echo "ACA_NAME=$ACA_NAME" >> $GITHUB_OUTPUT
                  echo "ACA_STATUS=$ACA_STATUS" >> $GITHUB_OUTPUT
                  echo "VM_NAME=$VM_NAME" >> $GITHUB_OUTPUT
                  echo "VM_SIZE=$VM_SIZE" >> $GITHUB_OUTPUT
                  echo "STORAGE_NAME=$STORAGE_NAME" >> $GITHUB_OUTPUT
                  echo "STORAGE_STATUS=$STORAGE_STATUS" >> $GITHUB_OUTPUT
                  echo "ACR_NAME=$ACR_NAME" >> $GITHUB_OUTPUT
                  echo "ACR_STATUS=$ACR_STATUS" >> $GITHUB_OUTPUT
                  echo "HEALTHY=$HEALTHY" >> $GITHUB_OUTPUT
                  echo "UNHEALTHY=$UNHEALTHY" >> $GITHUB_OUTPUT

            - name: Generate Report
              id: report
              run: |
                  mkdir -p reports/environment
                  REPORT_FILE="reports/environment/${{ steps.collect.outputs.REPORT_DATE }}.md"

                  # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸é–¢æ•°
                  badge() {
                    case "$1" in
                      Succeeded|Running) echo "âœ…" ;;
                      Failed) echo "âŒ" ;;
                      N/A) echo "âšª" ;;
                      *) echo "ğŸŸ¡" ;;
                    esac
                  }

                  cat << 'EOF' > $REPORT_FILE
                  # ğŸŒ ç’°å¢ƒãƒ¬ãƒãƒ¼ãƒˆ

                  **ç”Ÿæˆæ—¥æ™‚**: ${{ steps.collect.outputs.REPORT_TIME }}  
                  **ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—**: ${{ env.RESOURCE_GROUP }}  
                  **ç”Ÿæˆå…ƒ**: environment-reporter ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

                  ---

                  ## ğŸ“Š ã‚µãƒãƒªãƒ¼

                  | æŒ‡æ¨™ | å€¤ |
                  |------|-----|
                  | æ­£å¸¸ | ${{ steps.collect.outputs.HEALTHY }} |
                  | ç•°å¸¸ | ${{ steps.collect.outputs.UNHEALTHY }} |

                  ---

                  ## ğŸ–¥ï¸ ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ…‹

                  ### Azure Kubernetes Service (AKS)
                  - **åå‰**: ${{ steps.collect.outputs.AKS_NAME }}
                  - **çŠ¶æ…‹**: $(badge "${{ steps.collect.outputs.AKS_STATUS }}") ${{ steps.collect.outputs.AKS_STATUS }}
                  - **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ${{ steps.collect.outputs.AKS_VERSION }}
                  - **ãƒãƒ¼ãƒ‰æ•°**: ${{ steps.collect.outputs.AKS_NODE_COUNT }}

                  ### Azure Container Apps (ACA)
                  - **åå‰**: ${{ steps.collect.outputs.ACA_NAME }}
                  - **çŠ¶æ…‹**: $(badge "${{ steps.collect.outputs.ACA_STATUS }}") ${{ steps.collect.outputs.ACA_STATUS }}

                  ### Virtual Machine (VM)
                  - **åå‰**: ${{ steps.collect.outputs.VM_NAME }}
                  - **ã‚µã‚¤ã‚º**: ${{ steps.collect.outputs.VM_SIZE }}

                  ### Storage Account
                  - **åå‰**: ${{ steps.collect.outputs.STORAGE_NAME }}
                  - **çŠ¶æ…‹**: $(badge "${{ steps.collect.outputs.STORAGE_STATUS }}") ${{ steps.collect.outputs.STORAGE_STATUS }}

                  ### Azure Container Registry (ACR)
                  - **åå‰**: ${{ steps.collect.outputs.ACR_NAME }}
                  - **çŠ¶æ…‹**: $(badge "${{ steps.collect.outputs.ACR_STATUS }}") ${{ steps.collect.outputs.ACR_STATUS }}

                  ---

                  <details>
                  <summary>ğŸ“ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</summary>

                  - **ãƒ¬ãƒãƒ¼ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
                  - **ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: environment-reporter
                  - **å®Ÿè¡ŒID**: ${{ github.run_id }}

                  </details>
                  EOF

                  echo "REPORT_FILE=$REPORT_FILE" >> $GITHUB_OUTPUT

                  # Job Summary ã«å‡ºåŠ›
                  cat $REPORT_FILE >> $GITHUB_STEP_SUMMARY

            - name: Commit Report
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add reports/
                  git diff --staged --quiet || git commit -m "ğŸ“Š ç’°å¢ƒãƒ¬ãƒãƒ¼ãƒˆè¿½åŠ : ${{ steps.collect.outputs.REPORT_DATE }}"
                  git push || echo "No changes to push"

            - name: Create Issue (Optional)
              if: ${{ github.event.inputs.output_issue == 'true' }}
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const reportContent = fs.readFileSync('${{ steps.report.outputs.REPORT_FILE }}', 'utf8');
                      await github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: 'ğŸ“Š ç’°å¢ƒãƒ¬ãƒãƒ¼ãƒˆ ${{ steps.collect.outputs.REPORT_DATE }}',
                        body: reportContent,
                        labels: ['report', 'environment']
                      });
