# ãƒ‡ãƒ—ãƒ­ã‚¤å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Bicep What-If ã®çµæœã‚’è¦‹ã‚„ã™ãæ•´å½¢ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ

name: "ğŸ”„ Deploy Diff Report"
run-name: "ğŸ”„ Deploy Diff Report â€“ triggered by ${{ github.actor }}"

on:
    workflow_dispatch:
        inputs:
            resource_group:
                description: "ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å"
                required: false
                default: "RG-bbs-app-demo"
            template_file:
                description: "Bicepãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«"
                required: false
                default: "infra/main.bicep"
            parameters_file:
                description: "ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«"
                required: false
                default: "infra/parameters/main-dev.parameters.json"
            output_issue:
                description: "Issue ã«æŠ•ç¨¿ã™ã‚‹"
                type: boolean
                default: false

permissions:
    contents: write
    issues: write
    id-token: write

env:
    RESOURCE_GROUP: ${{ github.event.inputs.resource_group || vars.RESOURCE_GROUP || 'RG-bbs-app-demo' }}
    TEMPLATE_FILE: ${{ github.event.inputs.template_file || 'infra/main.bicep' }}
    PARAMETERS_FILE: ${{ github.event.inputs.parameters_file || 'infra/parameters/main-dev.parameters.json' }}

jobs:
    generate-report:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Azure Login
              uses: azure/login@v2
              with:
                  client-id: ${{ vars.AZURE_CLIENT_ID }}
                  tenant-id: ${{ vars.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Run What-If
              id: whatif
              run: |
                  echo "ğŸ”„ What-If åˆ†æã‚’å®Ÿè¡Œä¸­..."

                  REPORT_DATE=$(date +%Y-%m-%d)
                  REPORT_TIME=$(date +%Y-%m-%dT%H:%M:%SZ)

                  # What-If å®Ÿè¡Œ
                  WHATIF_OUTPUT=$(az deployment group what-if \
                    --resource-group ${{ env.RESOURCE_GROUP }} \
                    --template-file ${{ env.TEMPLATE_FILE }} \
                    --parameters @${{ env.PARAMETERS_FILE }} \
                    --result-format FullResourcePayloads \
                    -o json 2>/dev/null || echo '{"changes": []}')

                  # å¤‰æ›´ã‚¿ã‚¤ãƒ—åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
                  CREATE=$(echo $WHATIF_OUTPUT | jq '[.changes[] | select(.changeType=="Create")] | length')
                  MODIFY=$(echo $WHATIF_OUTPUT | jq '[.changes[] | select(.changeType=="Modify")] | length')
                  DELETE=$(echo $WHATIF_OUTPUT | jq '[.changes[] | select(.changeType=="Delete")] | length')
                  NO_CHANGE=$(echo $WHATIF_OUTPUT | jq '[.changes[] | select(.changeType=="NoChange")] | length')
                  TOTAL=$(echo $WHATIF_OUTPUT | jq '.changes | length')

                  # ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«åˆ¤å®š
                  if [ $DELETE -gt 0 ]; then
                    RISK_LEVEL="ğŸ”´ Critical"
                  elif [ $MODIFY -gt 5 ]; then
                    RISK_LEVEL="ğŸŸ  High"
                  elif [ $MODIFY -gt 0 ] || [ $CREATE -gt 0 ]; then
                    RISK_LEVEL="ğŸŸ¡ Medium"
                  else
                    RISK_LEVEL="ğŸŸ¢ Low"
                  fi

                  # å¤‰æ›´è©³ç´°
                  CHANGES_DETAIL=$(echo $WHATIF_OUTPUT | jq -r '
                    .changes[] | 
                    select(.changeType != "NoChange") |
                    "| \(.changeType) | \(.resourceId | split("/") | last) | \(.after.type // .before.type) |"
                  ' 2>/dev/null | head -20 || echo "| - | - | - |")

                  echo "REPORT_DATE=$REPORT_DATE" >> $GITHUB_OUTPUT
                  echo "REPORT_TIME=$REPORT_TIME" >> $GITHUB_OUTPUT
                  echo "CREATE=$CREATE" >> $GITHUB_OUTPUT
                  echo "MODIFY=$MODIFY" >> $GITHUB_OUTPUT
                  echo "DELETE=$DELETE" >> $GITHUB_OUTPUT
                  echo "NO_CHANGE=$NO_CHANGE" >> $GITHUB_OUTPUT
                  echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT
                  echo "RISK_LEVEL=$RISK_LEVEL" >> $GITHUB_OUTPUT
                  echo "CHANGES_DETAIL<<EOF" >> $GITHUB_OUTPUT
                  echo "$CHANGES_DETAIL" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Generate Report
              id: report
              run: |
                  mkdir -p reports/deploy-diff
                  REPORT_FILE="reports/deploy-diff/${{ steps.whatif.outputs.REPORT_DATE }}.md"

                  cat << EOF > $REPORT_FILE
                  # ğŸ”„ ãƒ‡ãƒ—ãƒ­ã‚¤å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆ

                  **ç”Ÿæˆæ—¥æ™‚**: ${{ steps.whatif.outputs.REPORT_TIME }}  
                  **ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—**: ${{ env.RESOURCE_GROUP }}  
                  **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: ${{ env.TEMPLATE_FILE }}  
                  **ç”Ÿæˆå…ƒ**: deploy-diff ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

                  ---

                  ## âš ï¸ ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«: ${{ steps.whatif.outputs.RISK_LEVEL }}

                  ---

                  ## ğŸ“Š å¤‰æ›´ã‚µãƒãƒªãƒ¼

                  | æ“ä½œ | ä»¶æ•° |
                  |------|------|
                  | â• ä½œæˆ | ${{ steps.whatif.outputs.CREATE }} |
                  | ğŸ“ å¤‰æ›´ | ${{ steps.whatif.outputs.MODIFY }} |
                  | âŒ å‰Šé™¤ | ${{ steps.whatif.outputs.DELETE }} |
                  | â¸ï¸ å¤‰æ›´ãªã— | ${{ steps.whatif.outputs.NO_CHANGE }} |
                  | **åˆè¨ˆ** | ${{ steps.whatif.outputs.TOTAL }} |

                  ---

                  ## ğŸ“‹ å¤‰æ›´è©³ç´°ï¼ˆä¸Šä½20ä»¶ï¼‰

                  | æ“ä½œ | ãƒªã‚½ãƒ¼ã‚¹å | ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ— |
                  |------|------------|----------------|
                  ${{ steps.whatif.outputs.CHANGES_DETAIL }}

                  ---

                  ## âš ï¸ æ³¨æ„äº‹é …

                  EOF

                  if [ "${{ steps.whatif.outputs.DELETE }}" -gt 0 ]; then
                    echo "- **ğŸ”´ å‰Šé™¤æ“ä½œãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼** ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«å½±éŸ¿ç¯„å›²ã‚’ç¢ºèªã—ã¦ãã ã•ã„" >> $REPORT_FILE
                  fi

                  if [ "${{ steps.whatif.outputs.MODIFY }}" -gt 5 ]; then
                    echo "- **ğŸŸ  å¤šæ•°ã®å¤‰æ›´ãŒå«ã¾ã‚Œã¦ã„ã¾ã™** æ®µéšçš„ãªãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ¤œè¨ã—ã¦ãã ã•ã„" >> $REPORT_FILE
                  fi

                  cat << EOF >> $REPORT_FILE

                  ---

                  ## âœ… æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

                  1. å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã®ä¸Šã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ‰¿èªã—ã¦ãã ã•ã„
                  2. å‰Šé™¤æ“ä½œãŒã‚ã‚‹å ´åˆã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„
                  3. æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨å‰ã«ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„

                  ---

                  <details>
                  <summary>ğŸ“ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</summary>

                  - **ãƒ¬ãƒãƒ¼ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
                  - **ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: deploy-diff
                  - **å®Ÿè¡ŒID**: ${{ github.run_id }}

                  </details>
                  EOF

                  echo "REPORT_FILE=$REPORT_FILE" >> $GITHUB_OUTPUT
                  cat $REPORT_FILE >> $GITHUB_STEP_SUMMARY

            - name: Commit Report
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add reports/
                  git diff --staged --quiet || git commit -m "ğŸ”„ ãƒ‡ãƒ—ãƒ­ã‚¤å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆè¿½åŠ : ${{ steps.whatif.outputs.REPORT_DATE }}"
                  git push || echo "No changes to push"

            - name: Create Issue (Optional)
              if: ${{ github.event.inputs.output_issue == 'true' }}
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const reportContent = fs.readFileSync('${{ steps.report.outputs.REPORT_FILE }}', 'utf8');
                      await github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: 'ğŸ”„ ãƒ‡ãƒ—ãƒ­ã‚¤å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆ ${{ steps.whatif.outputs.REPORT_DATE }}',
                        body: reportContent,
                        labels: ['report', 'deploy-diff']
                      });
