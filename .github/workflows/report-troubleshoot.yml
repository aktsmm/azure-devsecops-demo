# ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè‡ªå‹•ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—æ™‚ã« trouble_docs/ ã«è‡ªå‹•ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ

name: "ğŸ”§ Troubleshoot Doc Generator"
run-name: "ğŸ”§ Troubleshoot Doc Generator â€“ triggered by ${{ github.actor }}"

on:
    workflow_dispatch:
        inputs:
            run_id:
                description: "å¯¾è±¡ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒID"
                required: true
    workflow_run:
        workflows:
            - "1ï¸âƒ£ Infrastructure Deploy"
            - "2ï¸âƒ£ Build Board App"
            - "3ï¸âƒ£ Deploy Board App"
            - "4ï¸âƒ£ Build Admin App"
            - "5ï¸âƒ£ Deploy Admin App"
        types:
            - completed

permissions:
    contents: write
    actions: read

jobs:
    generate-troubleshoot-doc:
        # å¤±æ•—æ™‚ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿
        if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch' }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Get Failed Workflow Info
              id: info
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  echo "ğŸ”§ å¤±æ•—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æƒ…å ±ã‚’åé›†ä¸­..."

                  # å¯¾è±¡ã® run_id ã‚’æ±ºå®š
                  if [ -n "${{ github.event.inputs.run_id }}" ]; then
                    RUN_ID="${{ github.event.inputs.run_id }}"
                  else
                    RUN_ID="${{ github.event.workflow_run.id }}"
                  fi

                  REPORT_DATE=$(date +%Y-%m-%d)

                  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œæƒ…å ±ã‚’å–å¾—
                  RUN_INFO=$(gh run view $RUN_ID --json name,conclusion,createdAt,updatedAt,headBranch,event,jobs -q '.')

                  WORKFLOW_NAME=$(echo $RUN_INFO | jq -r '.name')
                  CONCLUSION=$(echo $RUN_INFO | jq -r '.conclusion')
                  CREATED_AT=$(echo $RUN_INFO | jq -r '.createdAt')
                  BRANCH=$(echo $RUN_INFO | jq -r '.headBranch')
                  EVENT=$(echo $RUN_INFO | jq -r '.event')

                  # å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ã‚’å–å¾—
                  FAILED_JOBS=$(echo $RUN_INFO | jq -r '.jobs[] | select(.conclusion=="failure") | .name' | head -5)

                  # ãƒ­ã‚°å–å¾—
                  echo "ğŸ“œ å¤±æ•—ãƒ­ã‚°ã‚’å–å¾—ä¸­..."
                  gh run view $RUN_ID --log-failed > /tmp/failed_log.txt 2>/dev/null || echo "ãƒ­ã‚°å–å¾—å¤±æ•—" > /tmp/failed_log.txt

                  # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ½å‡ºï¼ˆæœ€å¾Œã®50è¡Œï¼‰
                  ERROR_MESSAGES=$(tail -50 /tmp/failed_log.txt | grep -i "error\|failed\|exception" | head -10 || echo "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—å¤±æ•—")

                  # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚º
                  SAFE_NAME=$(echo "$WORKFLOW_NAME" | tr ' ' '-' | tr -cd '[:alnum:]-' | tr '[:upper:]' '[:lower:]')
                  DOC_FILENAME="${REPORT_DATE}-${SAFE_NAME}.md"

                  echo "RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT
                  echo "REPORT_DATE=$REPORT_DATE" >> $GITHUB_OUTPUT
                  echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
                  echo "CONCLUSION=$CONCLUSION" >> $GITHUB_OUTPUT
                  echo "CREATED_AT=$CREATED_AT" >> $GITHUB_OUTPUT
                  echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT
                  echo "EVENT=$EVENT" >> $GITHUB_OUTPUT
                  echo "FAILED_JOBS<<EOF" >> $GITHUB_OUTPUT
                  echo "$FAILED_JOBS" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT
                  echo "ERROR_MESSAGES<<EOF" >> $GITHUB_OUTPUT
                  echo "$ERROR_MESSAGES" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT
                  echo "DOC_FILENAME=$DOC_FILENAME" >> $GITHUB_OUTPUT

            - name: Generate Troubleshoot Document
              id: doc
              run: |
                  mkdir -p trouble_docs
                  DOC_FILE="trouble_docs/${{ steps.info.outputs.DOC_FILENAME }}"

                  cat << 'DOCEOF' > $DOC_FILE
                  # ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°: ${{ steps.info.outputs.WORKFLOW_NAME }}

                  **ç™ºç”Ÿæ—¥æ™‚**: ${{ steps.info.outputs.CREATED_AT }}  
                  **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âŒ ${{ steps.info.outputs.CONCLUSION }}  
                  **ãƒ–ãƒ©ãƒ³ãƒ**: `${{ steps.info.outputs.BRANCH }}`  
                  **ãƒˆãƒªã‚¬ãƒ¼**: ${{ steps.info.outputs.EVENT }}  
                  **å®Ÿè¡ŒID**: ${{ steps.info.outputs.RUN_ID }}

                  ---

                  ## ğŸ” å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–

                  ```
                  ${{ steps.info.outputs.FAILED_JOBS }}
                  ```

                  ---

                  ## âŒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

                  ```
                  ${{ steps.info.outputs.ERROR_MESSAGES }}
                  ```

                  ---

                  ## ğŸ“‹ ç¢ºèªäº‹é …ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

                  - [ ] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ãŸ
                  - [ ] åŒæ§˜ã®ã‚¨ãƒ©ãƒ¼ãŒéå»ã«ã‚ã‚‹ã‹ç¢ºèªã—ãŸ
                  - [ ] é–¢é€£ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ãŸ
                  - [ ] å¿…è¦ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ/å¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ãŸ
                  - [ ] ä¾å­˜ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆAzure, GitHubç­‰ï¼‰ã®éšœå®³ã‚’ç¢ºèªã—ãŸ

                  ---

                  ## ğŸ’¡ è€ƒãˆã‚‰ã‚Œã‚‹åŸå› 

                  1. **ãƒªã‚½ãƒ¼ã‚¹ä¸è¶³**: Azure ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¯ã‚©ãƒ¼ã‚¿åˆ¶é™
                  2. **èªè¨¼ã‚¨ãƒ©ãƒ¼**: Service Principal ã®æœŸé™åˆ‡ã‚Œã¾ãŸã¯æ¨©é™ä¸è¶³
                  3. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œ**: ä¸€æ™‚çš„ãªæ¥ç¶šéšœå®³
                  4. **è¨­å®šãƒŸã‚¹**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å€¤ãŒä¸æ­£
                  5. **ä¾å­˜é–¢ä¿‚**: å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ãŒæœªä½œæˆ

                  ---

                  ## ğŸ”§ è§£æ±ºç­–ï¼ˆèª¿æŸ»å¾Œã«è¨˜å…¥ï¼‰

                  **æ ¹æœ¬åŸå› **:
                  > ã“ã“ã«æ ¹æœ¬åŸå› ã‚’è¨˜å…¥

                  **è§£æ±ºæ–¹æ³•**:
                  > ã“ã“ã«è§£æ±ºæ–¹æ³•ã‚’è¨˜å…¥

                  **å†ç™ºé˜²æ­¢ç­–**:
                  > ã“ã“ã«å†ç™ºé˜²æ­¢ç­–ã‚’è¨˜å…¥

                  ---

                  ## ğŸ“ é–¢é€£ãƒªãƒ³ã‚¯

                  - [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°](https://github.com/${{ github.repository }}/actions/runs/${{ steps.info.outputs.RUN_ID }})
                  - [é–¢é€£ã™ã‚‹ trouble_docs](../trouble_docs/)

                  ---

                  <details>
                  <summary>ğŸ“ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</summary>

                  - **ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: troubleshooter
                  - **è‡ªå‹•ç”Ÿæˆæ—¥æ™‚**: ${{ steps.info.outputs.REPORT_DATE }}
                  - **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0

                  </details>
                  DOCEOF

                  echo "DOC_FILE=$DOC_FILE" >> $GITHUB_OUTPUT
                  cat $DOC_FILE >> $GITHUB_STEP_SUMMARY

            - name: Commit Document
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add trouble_docs/
                  git diff --staged --quiet || git commit -m "ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¿½åŠ : ${{ steps.info.outputs.DOC_FILENAME }}"
                  git push || echo "No changes to push"
