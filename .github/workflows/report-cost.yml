# ã‚³ã‚¹ãƒˆåˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Azure ã®ã‚³ã‚¹ãƒˆæƒ…å ±ã‚’åé›†ãƒ»åˆ†æã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ

name: "ğŸ’° Cost Analysis Report"
run-name: "ğŸ’° Cost Analysis Report â€“ triggered by ${{ github.actor }}"

on:
    workflow_dispatch:
        inputs:
            resource_group:
                description: "ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å"
                required: false
                default: "RG-bbs-app-demo"
            days:
                description: "åˆ†ææœŸé–“ï¼ˆæ—¥æ•°ï¼‰"
                required: false
                default: "30"
            output_issue:
                description: "Issue ã«æŠ•ç¨¿ã™ã‚‹"
                type: boolean
                default: false
    schedule:
        # æ¯æœˆ1æ—¥ 09:00 JST (00:00 UTC)
        - cron: "0 0 1 * *"

permissions:
    contents: write
    issues: write
    id-token: write

env:
    RESOURCE_GROUP: ${{ github.event.inputs.resource_group || vars.RESOURCE_GROUP || 'RG-bbs-app-demo' }}
    DAYS: ${{ github.event.inputs.days || '30' }}

jobs:
    generate-report:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Azure Login
              uses: azure/login@v2
              with:
                  client-id: ${{ vars.AZURE_CLIENT_ID }}
                  tenant-id: ${{ vars.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Collect Cost Data
              id: collect
              run: |
                  echo "ğŸ’° ã‚³ã‚¹ãƒˆæƒ…å ±ã‚’åé›†ä¸­..."

                  REPORT_DATE=$(date +%Y-%m-%d)
                  REPORT_TIME=$(date +%Y-%m-%dT%H:%M:%SZ)
                  END_DATE=$(date +%Y-%m-%d)
                  START_DATE=$(date -d "-${{ env.DAYS }} days" +%Y-%m-%d)

                  echo "æœŸé–“: $START_DATE ã€œ $END_DATE"

                  # ã‚³ã‚¹ãƒˆå–å¾—ï¼ˆCost Management APIï¼‰
                  # æ³¨: Cost Management API ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒå¿…è¦
                  COST_DATA=$(az consumption usage list \
                    --start-date $START_DATE \
                    --end-date $END_DATE \
                    --query "[?contains(instanceId, '${{ env.RESOURCE_GROUP }}')]" \
                    -o json 2>/dev/null || echo '[]')

                  # ã‚³ã‚¹ãƒˆé›†è¨ˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
                  TOTAL_COST=$(echo $COST_DATA | jq '[.[].pretaxCost // 0] | add // 0')
                  DAILY_AVG=$(echo "scale=2; $TOTAL_COST / ${{ env.DAYS }}" | bc 2>/dev/null || echo "0")

                  # ãƒªã‚½ãƒ¼ã‚¹åˆ¥é›†è¨ˆ
                  RESOURCE_COSTS=$(echo $COST_DATA | jq -r '
                    group_by(.instanceName) | 
                    map({name: .[0].instanceName, cost: ([.[].pretaxCost] | add)}) |
                    sort_by(-.cost) | 
                    .[0:5]' 2>/dev/null || echo '[]')

                  echo "REPORT_DATE=$REPORT_DATE" >> $GITHUB_OUTPUT
                  echo "REPORT_TIME=$REPORT_TIME" >> $GITHUB_OUTPUT
                  echo "START_DATE=$START_DATE" >> $GITHUB_OUTPUT
                  echo "END_DATE=$END_DATE" >> $GITHUB_OUTPUT
                  echo "TOTAL_COST=$TOTAL_COST" >> $GITHUB_OUTPUT
                  echo "DAILY_AVG=$DAILY_AVG" >> $GITHUB_OUTPUT
                  echo "RESOURCE_COSTS<<EOF" >> $GITHUB_OUTPUT
                  echo "$RESOURCE_COSTS" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Generate Report
              id: report
              run: |
                  mkdir -p reports/cost
                  REPORT_FILE="reports/cost/${{ steps.collect.outputs.REPORT_DATE }}.md"

                  cat << 'EOF' > $REPORT_FILE
                  # ğŸ’° ã‚³ã‚¹ãƒˆåˆ†æãƒ¬ãƒãƒ¼ãƒˆ

                  **ç”Ÿæˆæ—¥æ™‚**: ${{ steps.collect.outputs.REPORT_TIME }}  
                  **å¯¾è±¡æœŸé–“**: ${{ steps.collect.outputs.START_DATE }} ã€œ ${{ steps.collect.outputs.END_DATE }}  
                  **ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—**: ${{ env.RESOURCE_GROUP }}  
                  **ç”Ÿæˆå…ƒ**: cost-analyzer ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

                  ---

                  ## ğŸ“Š ã‚µãƒãƒªãƒ¼

                  | æŒ‡æ¨™ | å€¤ |
                  |------|-----|
                  | æœŸé–“å†…åˆè¨ˆ | Â¥${{ steps.collect.outputs.TOTAL_COST }} |
                  | æ—¥å¹³å‡ | Â¥${{ steps.collect.outputs.DAILY_AVG }} |
                  | å‚¾å‘ | â¡ï¸ æ¨ªã°ã„ |

                  ---

                  ## ğŸ“Š ãƒªã‚½ãƒ¼ã‚¹åˆ¥å†…è¨³ï¼ˆTop 5ï¼‰

                  | ãƒªã‚½ãƒ¼ã‚¹ | ã‚³ã‚¹ãƒˆ |
                  |----------|--------|
                  | (é›†è¨ˆä¸­) | - |

                  > ğŸ’¡ è©³ç´°ãªã‚³ã‚¹ãƒˆåˆ†æã«ã¯ Azure Cost Management ãƒãƒ¼ã‚¿ãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„

                  ---

                  ## ğŸ’¡ ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã®æ¨å¥¨äº‹é …

                  1. **VM ã®å¤œé–“åœæ­¢**: é–‹ç™ºç’°å¢ƒã® VM ã‚’å¤œé–“ãƒ»é€±æœ«ã«åœæ­¢ã™ã‚‹ã“ã¨ã§ç´„ 40% å‰Šæ¸›å¯èƒ½
                  2. **Storage Tier ã®è¦‹ç›´ã—**: ã‚¢ã‚¯ã‚»ã‚¹é »åº¦ã®ä½ã„ãƒ‡ãƒ¼ã‚¿ã¯ Cool/Archive Tier ã«ç§»è¡Œ
                  3. **ãƒªã‚¶ãƒ¼ãƒ–ãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹**: é•·æœŸåˆ©ç”¨ãƒªã‚½ãƒ¼ã‚¹ã¯ RI è³¼å…¥ã§æœ€å¤§ 72% å‰Šæ¸›

                  ---

                  <details>
                  <summary>ğŸ“ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</summary>

                  - **ãƒ¬ãƒãƒ¼ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
                  - **ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: cost-analyzer
                  - **å®Ÿè¡ŒID**: ${{ github.run_id }}

                  </details>
                  EOF

                  echo "REPORT_FILE=$REPORT_FILE" >> $GITHUB_OUTPUT
                  cat $REPORT_FILE >> $GITHUB_STEP_SUMMARY

            - name: Commit Report
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add reports/
                  git diff --staged --quiet || git commit -m "ğŸ’° ã‚³ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆè¿½åŠ : ${{ steps.collect.outputs.REPORT_DATE }}"
                  git push || echo "No changes to push"

            - name: Create Issue (Optional)
              if: ${{ github.event.inputs.output_issue == 'true' }}
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const reportContent = fs.readFileSync('${{ steps.report.outputs.REPORT_FILE }}', 'utf8');
                      await github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: 'ğŸ’° ã‚³ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ ${{ steps.collect.outputs.REPORT_DATE }}',
                        body: reportContent,
                        labels: ['report', 'cost']
                      });
