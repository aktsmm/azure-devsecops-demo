# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# CodeQL/Trivy/GitGuardian ã®ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’é›†ç´„ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ

name: "ğŸ” Security Audit Report"
run-name: "ğŸ” Security Audit Report â€“ triggered by ${{ github.actor }}"

on:
    workflow_dispatch:
        inputs:
            output_issue:
                description: "Issue ã«æŠ•ç¨¿ã™ã‚‹"
                type: boolean
                default: false
    schedule:
        # æ¯é€±æœˆæ›œ 10:00 JST (01:00 UTC)
        - cron: "0 1 * * 1"
    workflow_run:
        workflows: ["ğŸ” Security Scan (CodeQL + Trivy + Gitleaks)"]
        types:
            - completed

permissions:
    contents: write
    issues: write
    security-events: read
    actions: read

jobs:
    generate-report:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Collect Security Data
              id: collect
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  echo "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’åé›†ä¸­..."

                  REPORT_DATE=$(date +%Y-%m-%d)
                  REPORT_TIME=$(date +%Y-%m-%dT%H:%M:%SZ)

                  # CodeQL ã‚¢ãƒ©ãƒ¼ãƒˆå–å¾—
                  echo "ğŸ” CodeQLçµæœã‚’å–å¾—..."
                  CODEQL_ALERTS=$(gh api \
                    -H "Accept: application/vnd.github+json" \
                    /repos/${{ github.repository }}/code-scanning/alerts?state=open \
                    2>/dev/null || echo '[]')

                  CODEQL_CRITICAL=$(echo $CODEQL_ALERTS | jq '[.[] | select(.rule.security_severity_level=="critical")] | length')
                  CODEQL_HIGH=$(echo $CODEQL_ALERTS | jq '[.[] | select(.rule.security_severity_level=="high")] | length')
                  CODEQL_MEDIUM=$(echo $CODEQL_ALERTS | jq '[.[] | select(.rule.security_severity_level=="medium")] | length')
                  CODEQL_LOW=$(echo $CODEQL_ALERTS | jq '[.[] | select(.rule.security_severity_level=="low")] | length')

                  # Secret scanning ã‚¢ãƒ©ãƒ¼ãƒˆå–å¾—
                  echo "ğŸ” Secret scanningçµæœã‚’å–å¾—..."
                  SECRET_ALERTS=$(gh api \
                    -H "Accept: application/vnd.github+json" \
                    /repos/${{ github.repository }}/secret-scanning/alerts?state=open \
                    2>/dev/null || echo '[]')
                  SECRET_COUNT=$(echo $SECRET_ALERTS | jq 'length')

                  # Dependabot ã‚¢ãƒ©ãƒ¼ãƒˆå–å¾—
                  echo "ğŸ” Dependabotçµæœã‚’å–å¾—..."
                  DEPENDABOT_ALERTS=$(gh api \
                    -H "Accept: application/vnd.github+json" \
                    /repos/${{ github.repository }}/dependabot/alerts?state=open \
                    2>/dev/null || echo '[]')

                  DEP_CRITICAL=$(echo $DEPENDABOT_ALERTS | jq '[.[] | select(.security_advisory.severity=="critical")] | length')
                  DEP_HIGH=$(echo $DEPENDABOT_ALERTS | jq '[.[] | select(.security_advisory.severity=="high")] | length')
                  DEP_MEDIUM=$(echo $DEPENDABOT_ALERTS | jq '[.[] | select(.security_advisory.severity=="medium")] | length')
                  DEP_LOW=$(echo $DEPENDABOT_ALERTS | jq '[.[] | select(.security_advisory.severity=="low")] | length')

                  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰
                  TOTAL_ISSUES=$((CODEQL_CRITICAL + CODEQL_HIGH + CODEQL_MEDIUM + CODEQL_LOW + DEP_CRITICAL + DEP_HIGH + DEP_MEDIUM + DEP_LOW + SECRET_COUNT))
                  CRITICAL_WEIGHT=$((CODEQL_CRITICAL * 25 + DEP_CRITICAL * 25))
                  HIGH_WEIGHT=$((CODEQL_HIGH * 15 + DEP_HIGH * 15))
                  MEDIUM_WEIGHT=$((CODEQL_MEDIUM * 5 + DEP_MEDIUM * 5))
                  LOW_WEIGHT=$((CODEQL_LOW * 1 + DEP_LOW * 1))
                  DEDUCTION=$((CRITICAL_WEIGHT + HIGH_WEIGHT + MEDIUM_WEIGHT + LOW_WEIGHT + SECRET_COUNT * 50))
                  SECURITY_SCORE=$((100 - DEDUCTION))
                  if [ $SECURITY_SCORE -lt 0 ]; then SECURITY_SCORE=0; fi

                  echo "REPORT_DATE=$REPORT_DATE" >> $GITHUB_OUTPUT
                  echo "REPORT_TIME=$REPORT_TIME" >> $GITHUB_OUTPUT
                  echo "CODEQL_CRITICAL=$CODEQL_CRITICAL" >> $GITHUB_OUTPUT
                  echo "CODEQL_HIGH=$CODEQL_HIGH" >> $GITHUB_OUTPUT
                  echo "CODEQL_MEDIUM=$CODEQL_MEDIUM" >> $GITHUB_OUTPUT
                  echo "CODEQL_LOW=$CODEQL_LOW" >> $GITHUB_OUTPUT
                  echo "DEP_CRITICAL=$DEP_CRITICAL" >> $GITHUB_OUTPUT
                  echo "DEP_HIGH=$DEP_HIGH" >> $GITHUB_OUTPUT
                  echo "DEP_MEDIUM=$DEP_MEDIUM" >> $GITHUB_OUTPUT
                  echo "DEP_LOW=$DEP_LOW" >> $GITHUB_OUTPUT
                  echo "SECRET_COUNT=$SECRET_COUNT" >> $GITHUB_OUTPUT
                  echo "TOTAL_ISSUES=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
                  echo "SECURITY_SCORE=$SECURITY_SCORE" >> $GITHUB_OUTPUT

            - name: Generate Report
              id: report
              run: |
                  mkdir -p reports/security
                  REPORT_FILE="reports/security/${{ steps.collect.outputs.REPORT_DATE }}.md"

                  # ã‚¹ã‚³ã‚¢ãƒãƒƒã‚¸
                  SCORE=${{ steps.collect.outputs.SECURITY_SCORE }}
                  if [ $SCORE -ge 90 ]; then SCORE_BADGE="ğŸŸ¢ Excellent"; 
                  elif [ $SCORE -ge 70 ]; then SCORE_BADGE="ğŸŸ¡ Good";
                  elif [ $SCORE -ge 50 ]; then SCORE_BADGE="ğŸŸ  Fair";
                  else SCORE_BADGE="ğŸ”´ Poor"; fi

                  cat << EOF > $REPORT_FILE
                  # ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ

                  **ç”Ÿæˆæ—¥æ™‚**: ${{ steps.collect.outputs.REPORT_TIME }}  
                  **ãƒªãƒã‚¸ãƒˆãƒª**: ${{ github.repository }}  
                  **ç”Ÿæˆå…ƒ**: security-auditor ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

                  ---

                  ## ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢: ${{ steps.collect.outputs.SECURITY_SCORE }}/100 $SCORE_BADGE

                  ---

                  ## ğŸ” æ¤œå‡ºçµæœã‚µãƒãƒªãƒ¼

                  | ãƒ„ãƒ¼ãƒ« | Critical | High | Medium | Low |
                  |--------|----------|------|--------|-----|
                  | CodeQL | ${{ steps.collect.outputs.CODEQL_CRITICAL }} | ${{ steps.collect.outputs.CODEQL_HIGH }} | ${{ steps.collect.outputs.CODEQL_MEDIUM }} | ${{ steps.collect.outputs.CODEQL_LOW }} |
                  | Dependabot | ${{ steps.collect.outputs.DEP_CRITICAL }} | ${{ steps.collect.outputs.DEP_HIGH }} | ${{ steps.collect.outputs.DEP_MEDIUM }} | ${{ steps.collect.outputs.DEP_LOW }} |

                  ### ğŸ”‘ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º
                  - **æ¤œå‡ºæ•°**: ${{ steps.collect.outputs.SECRET_COUNT }}

                  ---

                  ## ğŸ“Š åˆè¨ˆ

                  | æŒ‡æ¨™ | å€¤ |
                  |------|-----|
                  | ç·æ¤œå‡ºæ•° | ${{ steps.collect.outputs.TOTAL_ISSUES }} |
                  | Critical | $((steps.collect.outputs.CODEQL_CRITICAL + steps.collect.outputs.DEP_CRITICAL)) |
                  | High | $((steps.collect.outputs.CODEQL_HIGH + steps.collect.outputs.DEP_HIGH)) |

                  ---

                  ## ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

                  1. **Critical/High ã®è„†å¼±æ€§ã‚’å„ªå…ˆå¯¾å¿œ**: æ—©æ€¥ã«ãƒ‘ãƒƒãƒé©ç”¨ã¾ãŸã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°
                  2. **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´©ã®ç¢ºèª**: æ¤œå‡ºã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¤œè¨
                  3. **å®šæœŸçš„ãªã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ**: é€±æ¬¡ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ

                  ---

                  <details>
                  <summary>ğŸ“ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</summary>

                  - **ãƒ¬ãƒãƒ¼ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
                  - **ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: security-auditor
                  - **å®Ÿè¡ŒID**: ${{ github.run_id }}

                  </details>
                  EOF

                  echo "REPORT_FILE=$REPORT_FILE" >> $GITHUB_OUTPUT
                  cat $REPORT_FILE >> $GITHUB_STEP_SUMMARY

            - name: Commit Report
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add reports/
                  git diff --staged --quiet || git commit -m "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆè¿½åŠ : ${{ steps.collect.outputs.REPORT_DATE }}"
                  git push || echo "No changes to push"

            - name: Create Issue (Optional)
              if: ${{ github.event.inputs.output_issue == 'true' }}
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const reportContent = fs.readFileSync('${{ steps.report.outputs.REPORT_FILE }}', 'utf8');
                      await github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: 'ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ ${{ steps.collect.outputs.REPORT_DATE }}',
                        body: reportContent,
                        labels: ['report', 'security']
                      });
