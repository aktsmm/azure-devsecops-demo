# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¥å…¨æ€§ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# GitHub Actions ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒçŠ¶æ³ã‚’åˆ†æã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ

name: "ğŸ”„ Workflow Health Report"
run-name: "ğŸ”„ Workflow Health Report â€“ triggered by ${{ github.actor }}"

on:
    workflow_dispatch:
        inputs:
            days:
                description: "åˆ†ææœŸé–“ï¼ˆæ—¥æ•°ï¼‰"
                required: false
                default: "7"
            output_issue:
                description: "Issue ã«æŠ•ç¨¿ã™ã‚‹"
                type: boolean
                default: false
    schedule:
        # æ¯é€±æœˆæ›œ 11:00 JST (02:00 UTC)
        - cron: "0 2 * * 1"

permissions:
    contents: write
    issues: write
    actions: read

jobs:
    generate-report:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Collect Workflow Data
              id: collect
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  echo "ğŸ”„ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå±¥æ­´ã‚’åé›†ä¸­..."

                  REPORT_DATE=$(date +%Y-%m-%d)
                  REPORT_TIME=$(date +%Y-%m-%dT%H:%M:%SZ)
                  DAYS=${{ github.event.inputs.days || '7' }}
                  START_DATE=$(date -d "-${DAYS} days" +%Y-%m-%dT00:00:00Z)

                  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå±¥æ­´ã‚’å–å¾—
                  RUNS=$(gh run list --limit 100 --json workflowName,status,conclusion,createdAt,updatedAt \
                    --jq "[.[] | select(.createdAt >= \"$START_DATE\")]")

                  # é›†è¨ˆ
                  TOTAL=$(echo $RUNS | jq 'length')
                  SUCCESS=$(echo $RUNS | jq '[.[] | select(.conclusion=="success")] | length')
                  FAILURE=$(echo $RUNS | jq '[.[] | select(.conclusion=="failure")] | length')
                  CANCELLED=$(echo $RUNS | jq '[.[] | select(.conclusion=="cancelled")] | length')
                  SKIPPED=$(echo $RUNS | jq '[.[] | select(.conclusion=="skipped")] | length')

                  # æˆåŠŸç‡è¨ˆç®—
                  if [ $TOTAL -gt 0 ]; then
                    SUCCESS_RATE=$(echo "scale=1; $SUCCESS * 100 / $TOTAL" | bc)
                  else
                    SUCCESS_RATE="0"
                  fi

                  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆ¥é›†è¨ˆ
                  WORKFLOW_STATS=$(echo $RUNS | jq -r '
                    group_by(.workflowName) |
                    map({
                      name: .[0].workflowName,
                      total: length,
                      success: ([.[] | select(.conclusion=="success")] | length),
                      failure: ([.[] | select(.conclusion=="failure")] | length)
                    }) |
                    sort_by(-.total)')

                  echo "REPORT_DATE=$REPORT_DATE" >> $GITHUB_OUTPUT
                  echo "REPORT_TIME=$REPORT_TIME" >> $GITHUB_OUTPUT
                  echo "DAYS=$DAYS" >> $GITHUB_OUTPUT
                  echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT
                  echo "SUCCESS=$SUCCESS" >> $GITHUB_OUTPUT
                  echo "FAILURE=$FAILURE" >> $GITHUB_OUTPUT
                  echo "CANCELLED=$CANCELLED" >> $GITHUB_OUTPUT
                  echo "SKIPPED=$SKIPPED" >> $GITHUB_OUTPUT
                  echo "SUCCESS_RATE=$SUCCESS_RATE" >> $GITHUB_OUTPUT
                  echo "WORKFLOW_STATS<<EOF" >> $GITHUB_OUTPUT
                  echo "$WORKFLOW_STATS" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Generate Report
              id: report
              run: |
                  mkdir -p reports/workflow-health
                  REPORT_FILE="reports/workflow-health/${{ steps.collect.outputs.REPORT_DATE }}.md"

                  # æˆåŠŸç‡ãƒãƒƒã‚¸
                  RATE=${{ steps.collect.outputs.SUCCESS_RATE }}
                  if (( $(echo "$RATE >= 90" | bc -l) )); then RATE_BADGE="ğŸŸ¢ Excellent";
                  elif (( $(echo "$RATE >= 70" | bc -l) )); then RATE_BADGE="ğŸŸ¡ Good";
                  elif (( $(echo "$RATE >= 50" | bc -l) )); then RATE_BADGE="ğŸŸ  Fair";
                  else RATE_BADGE="ğŸ”´ Needs Improvement"; fi

                  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
                  WF_TABLE=$(echo '${{ steps.collect.outputs.WORKFLOW_STATS }}' | jq -r '
                    .[] | "| \(.name) | \(.total) | \(.success) | \(.failure) | \(if .total > 0 then (.success * 100 / .total | floor) else 0 end)% |"
                  ' 2>/dev/null || echo "| - | - | - | - | - |")

                  cat << EOF > $REPORT_FILE
                  # ğŸ”„ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¥å…¨æ€§ãƒ¬ãƒãƒ¼ãƒˆ

                  **ç”Ÿæˆæ—¥æ™‚**: ${{ steps.collect.outputs.REPORT_TIME }}  
                  **å¯¾è±¡æœŸé–“**: éå» ${{ steps.collect.outputs.DAYS }} æ—¥é–“  
                  **ãƒªãƒã‚¸ãƒˆãƒª**: ${{ github.repository }}  
                  **ç”Ÿæˆå…ƒ**: workflow-health ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

                  ---

                  ## ğŸ“Š ã‚µãƒãƒªãƒ¼

                  | æŒ‡æ¨™ | å€¤ | è©•ä¾¡ |
                  |------|-----|------|
                  | **æˆåŠŸç‡** | ${{ steps.collect.outputs.SUCCESS_RATE }}% | $RATE_BADGE |
                  | ç·å®Ÿè¡Œæ•° | ${{ steps.collect.outputs.TOTAL }} | - |

                  ---

                  ## ğŸ“ˆ å®Ÿè¡Œçµæœå†…è¨³

                  | çµæœ | ä»¶æ•° | å‰²åˆ |
                  |------|------|------|
                  | âœ… æˆåŠŸ | ${{ steps.collect.outputs.SUCCESS }} | - |
                  | âŒ å¤±æ•— | ${{ steps.collect.outputs.FAILURE }} | - |
                  | â¸ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ« | ${{ steps.collect.outputs.CANCELLED }} | - |
                  | â­ï¸ ã‚¹ã‚­ãƒƒãƒ— | ${{ steps.collect.outputs.SKIPPED }} | - |

                  ---

                  ## ğŸ“‹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆ¥

                  | ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ | å®Ÿè¡Œæ•° | æˆåŠŸ | å¤±æ•— | æˆåŠŸç‡ |
                  |--------------|--------|------|------|--------|
                  $WF_TABLE

                  ---

                  ## ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

                  1. **å¤±æ•—ãŒå¤šã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å„ªå…ˆçš„ã«æ”¹å–„**
                  2. **flaky tests ã®ç‰¹å®šã¨ä¿®æ­£**
                  3. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã®é©æ­£åŒ–**

                  ---

                  <details>
                  <summary>ğŸ“ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</summary>

                  - **ãƒ¬ãƒãƒ¼ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
                  - **ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: workflow-health
                  - **å®Ÿè¡ŒID**: ${{ github.run_id }}

                  </details>
                  EOF

                  echo "REPORT_FILE=$REPORT_FILE" >> $GITHUB_OUTPUT
                  cat $REPORT_FILE >> $GITHUB_STEP_SUMMARY

            - name: Commit Report
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add reports/
                  git diff --staged --quiet || git commit -m "ğŸ”„ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ˜ãƒ«ã‚¹ãƒ¬ãƒãƒ¼ãƒˆè¿½åŠ : ${{ steps.collect.outputs.REPORT_DATE }}"
                  git push || echo "No changes to push"

            - name: Create Issue (Optional)
              if: ${{ github.event.inputs.output_issue == 'true' }}
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const reportContent = fs.readFileSync('${{ steps.report.outputs.REPORT_FILE }}', 'utf8');
                      await github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: 'ğŸ”„ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¥å…¨æ€§ãƒ¬ãƒãƒ¼ãƒˆ ${{ steps.collect.outputs.REPORT_DATE }}',
                        body: reportContent,
                        labels: ['report', 'workflow-health']
                      });
